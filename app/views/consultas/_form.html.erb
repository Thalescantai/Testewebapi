<% paciente ||= @paciente || consulta.paciente %>
<% show_exams = local_assigns.fetch(:show_exams, true) %>
<% show_materials = local_assigns.fetch(:show_materials, true) %>
<% show_diagnostico = local_assigns.fetch(:show_diagnostico, true) %>
<% submit_label = local_assigns.fetch(:submit_label, consulta.new_record? ? "Salvar consulta" : "Atualizar consulta") %>
<% finalize = local_assigns.fetch(:finalize, false) %>

<%= form_with(model: consulta,
              local: true,
              html: { style: "display: block; border: 1px solid #e4e7ef; border-radius: 12px; background: #fff; box-shadow: 0 2px 6px rgba(15,23,42,0.05); overflow: hidden;" }) do |form| %>
  <div style="padding: 1.25rem 1.5rem; background: #f4f6fb; border-bottom: 1px solid #e4e7ef;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.06em; font-weight: 600; color: #636a7a;">
          Consulta ambulatorial
        </div>
        <div style="font-size: 1.2rem; font-weight: 600; color: #1f2937; margin-top: 0.3rem;">
          <%= consulta.new_record? ? "Marcar nova consulta" : "Atualizar consulta" %>
        </div>
      </div>
      <i class="fas fa-stethoscope" style="font-size: 2rem; color: #10b981;"></i>
    </div>
    <% if paciente.present? %>
      <div style="margin-top: 0.75rem; font-size: 0.85rem; color: #6b7280;">
        <strong>Paciente:</strong> <%= paciente.nome %>
      </div>
    <% end %>
  </div>

  <div style="padding: 1.5rem;">
    <% if consulta.errors.any? %>
      <div style="border: 1px solid #fecaca; background: #fef2f2; color: #991b1b; border-radius: 8px; padding: 0.9rem 1rem; margin-bottom: 1.25rem;">
        <div style="font-weight: 600; margin-bottom: 0.5rem;">
          <i class="fas fa-exclamation-circle"></i>
          <%= pluralize(consulta.errors.count, "erro impede", plural: "erros impedem") %> o salvamento:
        </div>
        <ul style="margin: 0; padding-left: 1.1rem;">
          <% consulta.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <% if paciente.present? %>
      <%= form.hidden_field :paciente_id, value: paciente.id %>
    <% else %>
      <div style="margin-bottom: 1.25rem;">
        <%= form.label :paciente_id, "Paciente", style: "display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.35rem;" %>
        <%= form.collection_select :paciente_id, @pacientes, :id, :nome,
              { include_blank: "Selecione o paciente..." },
              { style: 'width: 100%; border: 1px solid #e4e7ef; border-radius: 8px; padding: 0.75rem 0.9rem; font-size: 0.95rem; color: #1f2937; background: #fff;' } %>
      </div>
    <% end %>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem;">
      <div style="min-width: 0;">
        <%= form.label :medico_id, "Médico responsável", style: "display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.35rem;" %>
        <%= form.collection_select :medico_id, @medicos, :id, :nome,
              { include_blank: "Selecione..." },
              { style: 'width: 100%; border: 1px solid #e4e7ef; border-radius: 8px; padding: 0.75rem 0.9rem; font-size: 0.95rem; color: #1f2937; background: #fff;' } %>
        <% if @medicos.empty? %>
          <small style="color: #9ca3af;">Cadastre um profissional com cargo \"Médico\" para habilitar esta seleção.</small>
        <% end %>
      </div>

      <div style="min-width: 0;">
        <%= form.label :data_hora, "Data e horário", style: "display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.35rem;" %>
        <%= form.datetime_field :data_hora, style: "width: 100%; border: 1px solid #e4e7ef; border-radius: 8px; padding: 0.7rem 0.9rem; font-size: 0.95rem; color: #1f2937;" %>
      </div>

      <div style="min-width: 0;">
        <%= form.label :tipo, "Tipo de consulta", style: "display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.35rem;" %>
        <%= form.text_field :tipo, placeholder: "Retorno, avaliação inicial...", style: "width: 100%; border: 1px solid #e4e7ef; border-radius: 8px; padding: 0.75rem 0.9rem; font-size: 0.95rem; color: #1f2937;" %>
      </div>

      <div style="min-width: 0;">
        <%= form.label :status, "Status", style: "display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.35rem;" %>
        <%= form.select :status,
              Consulta.statuses.keys.map { |key| [I18n.t("activerecord.attributes.consulta.statuses.#{key}", default: key.humanize), key] },
              {},
              style: "width: 100%; border: 1px solid #e4e7ef; border-radius: 8px; padding: 0.75rem 0.9rem; font-size: 0.95rem; color: #1f2937; background: #fff;" %>
      </div>
    </div>

    <% if show_exams %>
      <div style="margin-top: 1.75rem;">
        <div data-controller="nested-form"
             data-nested-form-wrapper-selector-value=".exame-fields"
             data-nested-form-max-items-value="10">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.85rem;">
            <div style="font-size: 0.9rem; font-weight: 700; color: #1f2937; text-transform: uppercase; letter-spacing: 0.05em;">
              Exames vinculados
            </div>
            <%= button_tag type: :button,
                           class: "add-exame-button",
                           data: { action: "click->nested-form#add", nested_form_target: "addButton" },
                           style: "padding: 0.55rem 1rem; border: 1px dashed #2563eb; border-radius: 8px; background: rgba(37,99,235,0.08); color: #2563eb; font-weight: 600; cursor: pointer;" do %>
              + Adicionar exame
            <% end %>
          </div>

          <template data-nested-form-target="template">
            <%= form.fields_for :exames, Exame.new, child_index: "NEW_RECORD" do |exame_form| %>
              <%= render "consultas/exame_fields", f: exame_form %>
            <% end %>
          </template>

          <div data-nested-form-target="container">
            <%= form.fields_for :exames do |exame_form| %>
              <%= render "consultas/exame_fields", f: exame_form %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <% if show_materials %>
      <div style="margin-top: 1.75rem;">
        <div data-controller="nested-form"
             data-nested-form-wrapper-selector-value=".material-fields"
             data-nested-form-max-items-value="15">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.85rem;">
            <div style="font-size: 0.9rem; font-weight: 700; color: #1f2937; text-transform: uppercase; letter-spacing: 0.05em;">
              Materiais solicitados
            </div>
            <%= button_tag type: :button,
                           class: "add-material-button",
                           data: { action: "click->nested-form#add", nested_form_target: "addButton" },
                           style: "padding: 0.55rem 1rem; border: 1px dashed #2563eb; border-radius: 8px; background: rgba(37,99,235,0.08); color: #2563eb; font-weight: 600; cursor: pointer;" do %>
              + Solicitar material
            <% end %>
          </div>

          <template data-nested-form-target="template">
            <%= form.fields_for :materials, Material.new, child_index: "NEW_RECORD" do |material_form| %>
              <%= render "consultas/material_fields", f: material_form %>
            <% end %>
          </template>

          <div data-nested-form-target="container">
            <%= form.fields_for :materials do |material_form| %>
              <%= render "consultas/material_fields", f: material_form %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <% if show_diagnostico %>
      <div style="margin-top: 1.25rem;">
        <%= form.label :diagnostico, "Diagnóstico / Conduta", style: "display: block; font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.35rem;" %>
        <%= form.text_area :diagnostico, placeholder: "Plano terapêutico, orientações e observações adicionais.", style: "width: 100%; border: 1px solid #e4e7ef; border-radius: 8px; padding: 0.9rem; font-size: 0.95rem; color: #1f2937; min-height: 120px;" %>
      </div>
    <% end %>
  </div>

  <div style="padding: 1.1rem 1.5rem; border-top: 1px solid #e4e7ef; background: #f9fafc; text-align: right;">
    <% cancel_path = paciente.present? ? paciente : (consulta.persisted? ? consulta : consultas_path) %>
    <%= link_to cancel_path, style: "margin-right: 0.75rem; padding: 0.65rem 1.2rem; border: 1px solid #e4e7ef; border-radius: 8px; font-weight: 600; color: #4b5563; text-decoration: none;" do %>
      Cancelar
    <% end %>
    <%= hidden_field_tag :finalizar_atendimento, "1" if finalize %>
    <%= form.submit submit_label, style: "padding: 0.7rem 1.4rem; background: #2563eb; color: #fff; border: none; border-radius: 8px; font-weight: 600; letter-spacing: 0.03em; cursor: pointer; box-shadow: 0 2px 4px rgba(37,99,235,0.35);" %>
  </div>
<% end %>
