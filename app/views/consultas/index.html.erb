<p style="color: green"><%= notice %></p>

<% content_for :title, "Consultas" %>

<div class="container-xl py-4">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;">
    <div style="display: flex; flex-direction: column; gap: 0.25rem;">
      <h1 style="margin: 0; font-size: 2rem; font-weight: 600; color: #1f2937;">Consultas agendadas</h1>
      <span style="font-size: 0.9rem; color: #6b7280;">Agora: <%= Time.zone.now.strftime("%d/%m/%Y %H:%M") %></span>
    </div>
    <%= link_to "Nova consulta", new_consulta_path, style: "display: inline-block; padding: 0.65rem 1rem; background: #2563eb; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600;" %>
  </div>

  <div style="margin-bottom: 1.25rem; border: 1px solid #e4e7ef; border-radius: 12px; background: #fff; box-shadow: 0 2px 6px rgba(15,23,42,0.05); padding: 1.1rem 1.25rem;">
    <%= form_with url: consultas_path, method: :get, local: true do |form| %>
      <%= form.hidden_field :status_filter, value: @status_filter %>
      <%= form.hidden_field :time_filter, value: @time_filter %>
      <div style="display: flex; align-items: flex-end; gap: 1rem; flex-wrap: wrap;">
        <div style="display: flex; flex-direction: column; gap: 0.35rem;">
          <label for="filter-date" style="font-size: 0.75rem; text-transform: uppercase; font-weight: 600; color: #6b7280;">Data</label>
          <%= form.date_field :filter_date,
                              value: @filter_date&.strftime("%Y-%m-%d"),
                              id: "filter-date",
                              style: "padding: 0.55rem 0.75rem; border-radius: 8px; border: 1px solid #d1d5db; min-width: 180px; font-size: 0.95rem; color: #1f2937;" %>
        </div>

        <div style="display: flex; flex-direction: column; gap: 0.35rem;">
          <label for="filter-professional" style="font-size: 0.75rem; text-transform: uppercase; font-weight: 600; color: #6b7280;">Profissional</label>
          <%= form.select :professional_id,
                          [["Todos os Profissionais...", ""]] + @medicos.map { |profissional| [profissional.nome, profissional.id] },
                          { selected: @selected_professional_id },
                          id: "filter-professional",
                          style: "padding: 0.55rem 2.5rem 0.55rem 0.75rem; border-radius: 8px; border: 1px solid #d1d5db; min-width: 220px; font-size: 0.95rem; color: #1f2937; background: #fff;" %>
        </div>

        <div style="flex: 1 1 260px; max-width: 340px; display: flex; flex-direction: column; gap: 0.35rem;">
          <label for="filter-search" style="font-size: 0.75rem; text-transform: uppercase; font-weight: 600; color: #6b7280;">Busca</label>
          <div style="position: relative;">
            <span style="position: absolute; inset: 0 auto 0 0; width: 42px; display: flex; align-items: center; justify-content: center; color: #9ca3af; pointer-events: none;">
              <i class="fas fa-search"></i>
            </span>
            <%= form.text_field :search,
                                value: @search_term,
                                id: "filter-search",
                                placeholder: "Buscar por paciente, CPF ou procedimento...",
                                style: "width: 100%; padding: 0.55rem 0.75rem 0.55rem 2.6rem; border-radius: 8px; border: 1px solid #d1d5db; font-size: 0.95rem; color: #1f2937;" %>
          </div>
        </div>
        <div style="display: flex; gap: 0.75rem; align-items: center; margin-left: auto;">
          <%= form.submit "Filtrar",
                          style: "padding: 0.6rem 1.1rem; border-radius: 8px; border: none; background: #2563eb; color: #fff; font-weight: 600; cursor: pointer; box-shadow: 0 3px 10px rgba(37,99,235,0.3);" %>
          <%= link_to "Limpar filtros",
                      consultas_path(status_filter: "todos", time_filter: "day"),
                      style: "padding: 0.55rem 1rem; border-radius: 8px; border: 1px solid #d1d5db; color: #4b5563; font-weight: 600; text-decoration: none; background: #fff; box-shadow: inset 0 0 0 1px #e5e7eb;" %>
        </div>
      </div>
    <% end %>
  </div>

  <% base_query = {
    filter_date: @filter_date&.strftime("%Y-%m-%d"),
    professional_id: @selected_professional_id,
    search: @search_term.presence,
    status_filter: @status_filter,
    time_filter: @time_filter
  }.compact %>
  <% status_filters = @status_filter_options %>
  <% time_filters = @time_filter_options %>

  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.25rem;">
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      <% status_filters.each do |key, label| %>
        <% active = key == @status_filter %>
        <%= link_to label,
                    consultas_path(base_query.merge(status_filter: key)),
                    style: "display: inline-block; padding: 0.45rem 0.95rem; border-radius: 999px; font-weight: 600; font-size: 0.9rem; text-decoration: none; transition: all 0.2s ease; background: #{active ? '#2563eb' : '#f3f4f6'}; color: #{active ? '#fff' : '#4b5563'}; box-shadow: #{active ? '0 4px 12px rgba(37,99,235,0.25)' : 'none'};" %>
      <% end %>
    </div>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      <% time_filters.each do |key, label| %>
        <% active = key == @time_filter %>
        <%= link_to label,
                    consultas_path(base_query.merge(time_filter: key)),
                    style: "display: inline-block; padding: 0.45rem 0.85rem; border-radius: 10px; font-weight: 600; font-size: 0.9rem; text-decoration: none; transition: all 0.2s ease; background: #{active ? '#0ea5e9' : '#f3f4f6'}; color: #{active ? '#fff' : '#4b5563'}; box-shadow: #{active ? '0 4px 12px rgba(14,165,233,0.25)' : 'none'};" %>
      <% end %>
    </div>
  </div>

  <div style="overflow-x: auto; border: 1px solid #e4e7ef; border-radius: 12px; background: #fff; box-shadow: 0 2px 6px rgba(15,23,42,0.05);">
    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
      <thead>
        <tr style="background: #f4f6fb; text-transform: uppercase; letter-spacing: 0.04em; color: #52606d;">
          <th style="border-bottom: 1px solid #e4e7ef; padding: 0.85rem; text-align: left; min-width: 200px;">Paciente</th>
          <th style="border-bottom: 1px solid #e4e7ef; padding: 0.85rem; text-align: left; min-width: 160px;">Data / hora</th>
          <th style="border-bottom: 1px solid #e4e7ef; padding: 0.85rem; text-align: left; min-width: 180px;">Profissional</th>
          <th style="border-bottom: 1px solid #e4e7ef; padding: 0.85rem; text-align: left; min-width: 160px;">Tipo</th>
          <th style="border-bottom: 1px solid #e4e7ef; padding: 0.85rem; text-align: left; min-width: 220px;">Exames</th>
          <th style="border-bottom: 1px solid #e4e7ef; padding: 0.85rem; text-align: center; min-width: 140px;">Status</th>
          <th style="border-bottom: 1px solid #e4e7ef; padding: 0.85rem; text-align: center; width: 160px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        <% if @consultas.any? %>
          <% @consultas.each do |consulta| %>
            <tr style="border-bottom: 1px solid #eef1f7;">
              <td style="padding: 0.85rem;">
                <div style="font-weight: 600; color: #1f2937;"><%= consulta.paciente&.nome || "—" %></div>
                <% if consulta.paciente&.cpf.present? %>
                  <div style="font-size: 0.75rem; color: #6b7280;">CPF: <%= consulta.paciente.cpf %></div>
                <% end %>
              </td>
              <td style="padding: 0.85rem; color: #1f2937;">
                <%= consulta.data_hora.present? ? l(consulta.data_hora, format: :long) : "—" %>
              </td>
              <td style="padding: 0.85rem; color: #374151;">
                <%= consulta.medico&.nome || "—" %>
              </td>
              <td style="padding: 0.85rem; color: #374151;">
                <%= consulta.tipo.presence || "—" %>
              </td>
              <td style="padding: 0.85rem; color: #4b5563;">
                <% if consulta.exames.any? %>
                  <ul style="margin: 0; padding-left: 1.1rem; display: grid; gap: 0.35rem;">
                    <% consulta.exames.each do |exame| %>
                      <li>
                        <strong><%= exame.nome_exame.presence || "Exame sem nome" %></strong>
                        <% if exame.data_exame.present? %>
                          <span style="color: #6b7280;">— <%= l(exame.data_exame) %></span>
                        <% end %>
                        <% if exame.observacao_exame.present? %>
                          <div style="font-size: 0.85rem; color: #6b7280;"><%= truncate(exame.observacao_exame, length: 60) %></div>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                <% else %>
                  <span style="color: #6b7280;">Nenhum exame vinculado</span>
                <% end %>
              </td>
              <td style="padding: 0.85rem; color: #4b5563;">
                <% status_labels = {
                     "agendado" => "Agendado",
                     "atendido" => "Atendido na Recepção",
                     "faltou" => "Cancelado",
                     "finalizado" => "Paciente Atendido"
                   } %>
                <% status_colors = {
                     "agendado" => ["#dbeafe", "#1d4ed8"],
                     "atendido" => ["#fef3c7", "#b45309"],
                     "faltou" => ["#fee2e2", "#b91c1c"],
                     "finalizado" => ["#dcfce7", "#15803d"]
                   } %>
                <% current_status = consulta.status %>
                <% bg, fg = status_colors.fetch(current_status, ["#e5e7eb", "#374151"]) %>
                <span style="display: inline-block; padding: 0.35rem 0.8rem; border-radius: 999px; font-weight: 600; font-size: 0.85rem; background: <%= bg %>; color: <%= fg %>;">
                  <%= status_labels.fetch(current_status, current_status.humanize) %>
                </span>
              </td>
              <td style="padding: 0.85rem; text-align: center;">
                <% if consulta.checkin? %>
                  <span style="display: inline-block; margin-right: 0.5rem; padding: 0.4rem 0.75rem; border-radius: 999px; background: #dcfce7; color: #15803d; font-weight: 600; font-size: 0.85rem;">
                    Check-in realizado
                  </span>
                <% else %>
                  <%= button_to "Dar check-in",
                                checkin_consulta_path(consulta),
                                method: :patch,
                                class: "btn btn-sm",
                                form: { style: "display: inline;" },
                                style: "display: inline-block; margin-right: 0.5rem; padding: 0.45rem 0.9rem; border-radius: 8px; background: #2563eb; color: #fff; border: none; cursor: pointer; font-weight: 600;",
                                data: { turbo_confirm: "Confirmar check-in para esta consulta?" } %>
                <% end %>
                <%= link_to "Ver", consulta, style: "margin-right: 0.5rem; color: #2563eb; text-decoration: none; font-weight: 600;" %>
                <%= link_to "Editar", edit_consulta_path(consulta), style: "margin-right: 0.5rem; color: #16a34a; text-decoration: none; font-weight: 600;" %>
                <%= button_to "Excluir", consulta, method: :delete, data: { turbo_confirm: "Deseja remover esta consulta?" }, form: { style: "display: inline;" }, style: "background: transparent; border: none; color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline;" %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="7" style="padding: 1.25rem; text-align: center; color: #6b7280;">
              <i class="fas fa-info-circle" style="margin-right: 0.35rem;"></i>
              Nenhuma consulta encontrada para os filtros selecionados.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
