<div class="container mt-4">
  <!-- üîπ Cabe√ßalho -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary mb-0">
      <i class="fas fa-users me-2"></i> Pacientes Cadastrados
    </h2>

    <%= link_to new_paciente_path, class: "btn btn-primary shadow-sm px-3 py-2" do %>
      <i class="fas fa-plus me-1"></i> Novo Paciente
    <% end %>
  </div>

  <!-- üîç Filtros de Busca -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <%= search_form_for @q, url: pacientes_path, method: :get, html: { class: "row gy-3 gx-3" } do |f| %>
        <div class="col-md-3">
          <%= f.label :nome_cont, "Nome", class: "form-label fw-semibold text-secondary" %>
          <%= f.search_field :nome_cont, class: "form-control shadow-sm", placeholder: "Buscar por nome..." %>
        </div>

        <div class="col-md-3">
          <%= f.label :cpf_cont, "CPF", class: "form-label fw-semibold text-secondary" %>
          <%= f.search_field :cpf_cont, class: "form-control shadow-sm", placeholder: "Buscar por CPF..." %>
        </div>

        <div class="col-md-3">
          <%= f.label :email_cont, "Email", class: "form-label fw-semibold text-secondary" %>
          <%= f.search_field :email_cont, class: "form-control shadow-sm", placeholder: "Buscar por email..." %>
        </div>

        <div class="col-md-2">
          <%= f.label :sexo_eq, "Sexo", class: "form-label fw-semibold text-secondary" %>
          <%= f.select :sexo_eq,
                [["Masculino", "masculino"], ["Feminino", "feminino"], ["Indefinido", "indefinido"]],
                { include_blank: "Todos" },
                class: "form-select shadow-sm" %>
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <%= f.submit "Filtrar", class: "btn btn-success w-100 shadow-sm" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- üìã Tabela -->
  <div class="card border-0 shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-primary text-white text-center">
          <tr>
            <th><%= sort_link(@q, :nome, "Nome", class: "text-white text-decoration-none") %></th>
            <th>CPF</th>
            <th>Sexo</th>
            <th>Idade</th>
            <th>Email</th>
            <th>Celular</th>
            <th>Data Nasc.</th>
            <th>Observa√ß√µes</th>
            <th class="text-end">A√ß√µes</th>
          </tr>
        </thead>

        <tbody>
          <% if @pacientes.any? %>
            <% @pacientes.each do |paciente| %>
              <tr class="text-center">
                <td class="fw-semibold text-start ps-3">
                  <i class="fas fa-user text-primary me-1"></i>
                  <%= paciente.nome %>
                </td>
                <td><%= paciente.cpf.presence || "-" %></td>
                <td>
                  <% if paciente.sexo.present? %>
                    <% badge_color = case paciente.sexo
                      when "masculino" then "primary"
                      when "feminino" then "danger"
                      else "secondary"
                    end %>
                    <span class="badge bg-<%= badge_color %> px-2 py-2"><%= paciente.sexo.capitalize %></span>
                  <% else %>
                    -
                  <% end %>
                </td>
                <td>
                  <% if paciente.data_nascimento.present? %>
                    <% idade = ((Time.zone.now - paciente.data_nascimento.to_time) / 1.year.seconds).floor %>
                    <%= idade %> anos
                  <% else %>
                    -
                  <% end %>
                </td>
                <td><%= paciente.email.presence || "-" %></td>
                <td><%= paciente.celular.presence || "-" %></td>
                <td><%= paciente.data_nascimento&.strftime("%d/%m/%Y") || "-" %></td>
                <td class="text-truncate" style="max-width: 180px;">
                  <%= truncate(paciente.observacao, length: 40) if paciente.observacao.present? %>
                </td>

                <td class="text-end pe-3">
                  <div class="btn-group" role="group">
                    <%= link_to paciente, class: "btn btn-sm btn-outline-primary", title: "Visualizar", data: { bs_toggle: "tooltip" } do %>
                      <i class="fas fa-eye"></i>
                    <% end %>

                    <%= link_to edit_paciente_path(paciente), class: "btn btn-sm btn-outline-success", title: "Editar", data: { bs_toggle: "tooltip" } do %>
                      <i class="fas fa-edit"></i>
                    <% end %>

                    <%= link_to paciente,
                        data: { turbo_method: :delete, turbo_confirm: "Deseja realmente excluir este paciente?" },
                        class: "btn btn-sm btn-outline-danger", title: "Excluir", data: { bs_toggle: "tooltip" } do %>
                      <i class="fas fa-trash"></i>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="9" class="text-center py-4 text-muted">
                <i class="fas fa-info-circle me-2"></i>
                Nenhum paciente encontrado.
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- üìÑ Pagina√ß√£o -->
  <div class="mt-4 d-flex justify-content-center">
    <%= paginate @pacientes %>
  </div>
</div>

<!-- üß† Tooltip Bootstrap -->
<script>
  document.addEventListener("turbo:load", function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  })
</script>
